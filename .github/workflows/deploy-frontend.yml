name: Deploy Frontend to Elastic Beanstalk

on:
  push:
    branches: [main]
    paths:
      - 'web/energy-dashboard/**'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  EB_APP_NAME: energy-dashboard-frontend
  EB_ENV_NAME: energy-dashboard-frontend-env
  S3_BUCKET: energy-dashboard-deployments

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build Frontend (Linux amd64)
        working-directory: web/energy-dashboard
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: amd64
        run: |
          go mod tidy
          go build -o energy-dashboard-go ./main.go
          ls -lh energy-dashboard-go

      - name: Zip Frontend Application
        working-directory: web/energy-dashboard
        run: |
          zip -r frontend-app.zip \
            energy-dashboard-go \
            Procfile \
            templates/ \
            static/ \
            -x "*.git*" "*.env*"
          ls -lh frontend-app.zip

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Ensure S3 bucket exists (no-op if it does)
        run: |
          if ! aws s3 ls "s3://${{ env.S3_BUCKET }}" >/dev/null 2>&1; then
            aws s3 mb "s3://${{ env.S3_BUCKET }}" --region "${{ env.AWS_REGION }}"
          fi

      - name: Upload Frontend to S3
        working-directory: web/energy-dashboard
        run: |
          aws s3 cp frontend-app.zip "s3://${{ env.S3_BUCKET }}/frontend-app.zip" --region "${{ env.AWS_REGION }}"

      - name: Create EB Application (if needed)
        run: |
          if [ "$(aws elasticbeanstalk describe-applications \
                --application-names "${{ env.EB_APP_NAME }}" \
                --query 'length(Applications)' \
                --output text 2>/dev/null)" = "0" ]; then
            aws elasticbeanstalk create-application \
              --application-name "${{ env.EB_APP_NAME }}" \
              --region "${{ env.AWS_REGION }}"
          fi

      - name: Create EB Application Version
        run: |
          VERSION_LABEL="v1-$(date +%Y%m%d%H%M%S)"
          echo "Using version: $VERSION_LABEL"
          aws elasticbeanstalk create-application-version \
            --application-name "${{ env.EB_APP_NAME }}" \
            --version-label "$VERSION_LABEL" \
            --source-bundle S3Bucket="${{ env.S3_BUCKET }}",S3Key=frontend-app.zip \
            --region "${{ env.AWS_REGION }}"
          echo "VERSION_LABEL=$VERSION_LABEL" >> "$GITHUB_ENV"

      - name: Resolve EB Platform ARN (Go on AL2023)
        run: |
          PLATFORM_ARN=$(aws elasticbeanstalk list-platform-versions \
            --region "${{ env.AWS_REGION }}" \
            --filters Type="PlatformName",Operator="=",Value="Go 1 running on 64bit Amazon Linux 2023" \
            --query 'sort_by(PlatformSummaryList,&PlatformVersion)[-1].PlatformArn' \
            --output text)
          if [ -z "$PLATFORM_ARN" ] || [ "$PLATFORM_ARN" = "None" ]; then
            echo "Failed to resolve AL2023 Go platform ARN" >&2
            exit 1
          fi
          echo "Using platform: $PLATFORM_ARN"
          echo "PLATFORM_ARN=$PLATFORM_ARN" >> "$GITHUB_ENV"

      - name: Check/Create EB Environment
        run: |
          EXISTING_ENV=$(aws elasticbeanstalk describe-environments \
            --application-name "${{ env.EB_APP_NAME }}" \
            --environment-names "${{ env.EB_ENV_NAME }}" \
            --query 'Environments[?Status!=`Terminated`].EnvironmentName' \
            --output text \
            --region "${{ env.AWS_REGION }}")

          if [ -z "$EXISTING_ENV" ]; then
            echo "Creating new environment..."
            aws elasticbeanstalk create-environment \
              --application-name "${{ env.EB_APP_NAME }}" \
              --environment-name "${{ env.EB_ENV_NAME }}" \
              --platform-arn "$PLATFORM_ARN" \
              --version-label "$VERSION_LABEL" \
              --option-settings \
                Namespace=aws:elasticbeanstalk:application:environment,OptionName=API_URL,Value=http://smart-energy-grid-env.eba-qgkwbhh7.us-east-1.elasticbeanstalk.com \
                Namespace=aws:elasticbeanstalk:application:environment,OptionName=PORT,Value=3000 \
              --region "${{ env.AWS_REGION }}"

            # (Optional) Wait for environment health to become Ready/Green before continuing
            aws elasticbeanstalk wait environment-exists \
              --application-name "${{ env.EB_APP_NAME }}" \
              --environment-names "${{ env.EB_ENV_NAME }}" \
              --region "${{ env.AWS_REGION }}"
          else
            echo "Environment already exists: ${EXISTING_ENV}"
          fi

      - name: Deploy Frontend to Elastic Beanstalk
        run: |
          aws elasticbeanstalk update-environment \
            --application-name "${{ env.EB_APP_NAME }}" \
            --environment-name "${{ env.EB_ENV_NAME }}" \
            --version-label "$VERSION_LABEL" \
            --region "${{ env.AWS_REGION }}"

      - name: Output Environment URL
        run: |
          URL=$(aws elasticbeanstalk describe-environments \
            --application-name "${{ env.EB_APP_NAME }}" \
            --environment-names "${{ env.EB_ENV_NAME }}" \
            --query 'Environments[0].CNAME' --output text \
            --region "${{ env.AWS_REGION }}")
          echo "âœ… Frontend URL: http://${URL}"
