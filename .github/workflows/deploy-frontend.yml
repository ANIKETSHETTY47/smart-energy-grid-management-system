name: Deploy Frontend to Elastic Beanstalk

on:
  push:
    branches: [main]
    paths:
      - 'web/energy-dashboard/**'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  EB_APP_NAME: energy-dashboard-frontend
  EB_ENV_NAME: energy-dashboard-frontend-env

jobs:
  deploy:
    name: Deploy Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install EB CLI
        run: |
          pip install awsebcli --upgrade --user
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Initialize Elastic Beanstalk
        working-directory: web/energy-dashboard
        run: |
          eb --version
          
          # Create .elasticbeanstalk directory if it doesn't exist
          mkdir -p .elasticbeanstalk
          
          # Create config file without problematic settings
          cat > .elasticbeanstalk/config.yml << EOF
          branch-defaults:
            main:
              environment: ${{ env.EB_ENV_NAME }}
          global:
            application_name: ${{ env.EB_APP_NAME }}
            default_region: ${{ env.AWS_REGION }}
            platform: Go 1 running on 64bit Amazon Linux 2023
            sc: git
          EOF
          
          cat .elasticbeanstalk/config.yml

      - name: Create or Use Existing Environment
        working-directory: web/energy-dashboard
        run: |
          # Check if environment exists
          if eb list | grep -q "${{ env.EB_ENV_NAME }}"; then
            echo "✅ Environment exists, will deploy to it"
          else
            echo "Creating new environment..."
            eb create ${{ env.EB_ENV_NAME }} \
              --instance-type t3.micro \
              --single \
              --envvars API_URL=http://smart-energy-grid-env.us-east-1.elasticbeanstalk.com,PORT=3000 \
              --timeout 20
          fi

      - name: Set Environment Variables
        working-directory: web/energy-dashboard
        run: |
          # Set backend URL (update this after backend is deployed)
          eb setenv API_URL=http://smart-energy-grid-env.us-east-1.elasticbeanstalk.com PORT=3000

      - name: Deploy Application
        working-directory: web/energy-dashboard
        run: |
          eb deploy ${{ env.EB_ENV_NAME }}

      - name: Get Environment Info
        working-directory: web/energy-dashboard
        run: |
          eb status ${{ env.EB_ENV_NAME }}
          echo ""
          echo "================================"
          echo "✅ Frontend URL:"
          eb status ${{ env.EB_ENV_NAME }} | grep "CNAME" | awk '{print "http://"$2}'
          echo "================================"