name: Deploy Frontend to Elastic Beanstalk

on:
  push:
    branches: [main]
    paths:
      - 'web/energy-dashboard/**'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  EB_APP_NAME: energy-dashboard-frontend
  EB_ENV_NAME: energy-dashboard-frontend-env
  S3_BUCKET: energy-dashboard-deployments
  # Required IAM roles
  SERVICE_ROLE: aws-elasticbeanstalk-service-role
  INSTANCE_PROFILE: aws-elasticbeanstalk-ec2-role

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build Frontend (Linux amd64)
        working-directory: web/energy-dashboard
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: amd64
        run: |
          go mod tidy
          go build -o energy-dashboard-go ./main.go
          ls -lh energy-dashboard-go

      - name: Zip Frontend Application
        working-directory: web/energy-dashboard
        run: |
          zip -r frontend-app.zip \
            energy-dashboard-go \
            Procfile \
            templates/ \
            static/ \
            -x "*.git*" "*.env*"
          ls -lh frontend-app.zip

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Ensure S3 bucket exists
        run: |
          if ! aws s3 ls "s3://${{ env.S3_BUCKET }}" 2>&1 | grep -q ""; then
            echo "Creating S3 bucket..."
            aws s3 mb "s3://${{ env.S3_BUCKET }}" --region "${{ env.AWS_REGION }}"
          else
            echo "✅ S3 bucket exists"
          fi

      - name: Upload Frontend to S3
        working-directory: web/energy-dashboard
        run: |
          aws s3 cp frontend-app.zip "s3://${{ env.S3_BUCKET }}/frontend-app.zip" --region "${{ env.AWS_REGION }}"
          echo "✅ Uploaded to S3"

      - name: Create EB Application (if needed)
        run: |
          APP_COUNT=$(aws elasticbeanstalk describe-applications \
            --application-names "${{ env.EB_APP_NAME }}" \
            --query 'length(Applications)' \
            --output text 2>/dev/null || echo "0")
          
          if [ "$APP_COUNT" = "0" ]; then
            echo "Creating EB application..."
            aws elasticbeanstalk create-application \
              --application-name "${{ env.EB_APP_NAME }}" \
              --region "${{ env.AWS_REGION }}"
            echo "✅ Application created"
          else
            echo "✅ Application already exists"
          fi

      - name: Create EB Application Version
        run: |
          VERSION_LABEL="v1-$(date +%Y%m%d%H%M%S)"
          echo "Creating version: $VERSION_LABEL"
          aws elasticbeanstalk create-application-version \
            --application-name "${{ env.EB_APP_NAME }}" \
            --version-label "$VERSION_LABEL" \
            --source-bundle S3Bucket="${{ env.S3_BUCKET }}",S3Key=frontend-app.zip \
            --region "${{ env.AWS_REGION }}"
          
          # Write to GITHUB_ENV safely
          {
            echo "VERSION_LABEL=${VERSION_LABEL}"
          } >> "$GITHUB_ENV"
          
          echo "✅ Version created: $VERSION_LABEL"

      - name: Resolve EB Platform ARN (Go on AL2023)
        run: |
          set -e  # Exit on any error
          set -o pipefail  # Exit on pipe failures
          
          echo "Searching for Go platform on AL2023..."
          
          # First, list all available Go platforms for debugging
          echo "Available Go platforms:"
          aws elasticbeanstalk list-platform-versions \
            --region "${{ env.AWS_REGION }}" \
            --query "PlatformSummaryList[?contains(PlatformBranchName, 'Go')].{Name:PlatformBranchName,Version:PlatformVersion,ARN:PlatformArn}" \
            --output table
          
          # Try AL2023 Go platform first - capture to temp file to avoid any output issues
          echo ""
          echo "Attempting to find AL2023 Go platform..."
          
          # Use temporary file to capture output cleanly
          TEMP_FILE=$(mktemp)
          aws elasticbeanstalk list-platform-versions \
            --region "${{ env.AWS_REGION }}" \
            --query "reverse(sort_by(PlatformSummaryList[?contains(PlatformBranchName, 'Go') && contains(PlatformBranchName, '2023')], &PlatformVersion))[0].PlatformArn" \
            --output text > "$TEMP_FILE" 2>&1
          
          # Read and clean the output - remove any whitespace, newlines, and "None" strings
          PLATFORM_ARN=$(cat "$TEMP_FILE" | grep -v '^None

      - name: Check/Create IAM Instance Profile
        run: |
          set -e
          echo "Checking IAM Instance Profile..."
          
          if aws iam get-instance-profile --instance-profile-name "${{ env.INSTANCE_PROFILE }}" >/dev/null 2>&1; then
            echo "✅ Instance profile already exists"
          else
            echo "Creating IAM role and instance profile..."
            
            # Create the role
            aws iam create-role \
              --role-name "${{ env.INSTANCE_PROFILE }}" \
              --assume-role-policy-document '{
                "Version": "2012-10-17",
                "Statement": [{
                  "Effect": "Allow",
                  "Principal": {"Service": "ec2.amazonaws.com"},
                  "Action": "sts:AssumeRole"
                }]
              }' 2>/dev/null || echo "Role may already exist"
            
            # Attach managed policies
            aws iam attach-role-policy \
              --role-name "${{ env.INSTANCE_PROFILE }}" \
              --policy-arn arn:aws:iam::aws:policy/AWSElasticBeanstalkWebTier 2>/dev/null || true
            
            aws iam attach-role-policy \
              --role-name "${{ env.INSTANCE_PROFILE }}" \
              --policy-arn arn:aws:iam::aws:policy/AWSElasticBeanstalkWorkerTier 2>/dev/null || true
            
            aws iam attach-role-policy \
              --role-name "${{ env.INSTANCE_PROFILE }}" \
              --policy-arn arn:aws:iam::aws:policy/AWSElasticBeanstalkMulticontainerDocker 2>/dev/null || true
            
            # Create instance profile
            aws iam create-instance-profile \
              --instance-profile-name "${{ env.INSTANCE_PROFILE }}" 2>/dev/null || echo "Instance profile may already exist"
            
            # Add role to instance profile
            aws iam add-role-to-instance-profile \
              --instance-profile-name "${{ env.INSTANCE_PROFILE }}" \
              --role-name "${{ env.INSTANCE_PROFILE }}" 2>/dev/null || true
            
            echo "Waiting for IAM propagation..."
            sleep 10
            echo "✅ Instance profile created"
          fi

      - name: Check/Create Service Role
        run: |
          set -e
          echo "Checking Service Role..."
          
          if aws iam get-role --role-name "${{ env.SERVICE_ROLE }}" >/dev/null 2>&1; then
            echo "✅ Service role already exists"
          else
            echo "Creating service role..."
            
            aws iam create-role \
              --role-name "${{ env.SERVICE_ROLE }}" \
              --assume-role-policy-document '{
                "Version": "2012-10-17",
                "Statement": [{
                  "Effect": "Allow",
                  "Principal": {"Service": "elasticbeanstalk.amazonaws.com"},
                  "Action": "sts:AssumeRole",
                  "Condition": {
                    "StringEquals": {
                      "sts:ExternalId": "elasticbeanstalk"
                    }
                  }
                }]
              }' 2>/dev/null || echo "Role may already exist"
            
            aws iam attach-role-policy \
              --role-name "${{ env.SERVICE_ROLE }}" \
              --policy-arn arn:aws:iam::aws:policy/service-role/AWSElasticBeanstalkEnhancedHealth 2>/dev/null || true
            
            aws iam attach-role-policy \
              --role-name "${{ env.SERVICE_ROLE }}" \
              --policy-arn arn:aws:iam::aws:policy/AWSElasticBeanstalkManagedUpdatesCustomerRolePolicy 2>/dev/null || true
            
            echo "Waiting for IAM propagation..."
            sleep 10
            echo "✅ Service role created"
          fi

      - name: Check/Create EB Environment
        run: |
          set -e
          echo "Checking if environment exists..."
          
          EXISTING_ENV=$(aws elasticbeanstalk describe-environments \
            --application-name "${{ env.EB_APP_NAME }}" \
            --environment-names "${{ env.EB_ENV_NAME }}" \
            --query 'Environments[?Status!=`Terminated`].EnvironmentName' \
            --output text \
            --region "${{ env.AWS_REGION }}" 2>/dev/null || echo "")

          if [ -z "$EXISTING_ENV" ]; then
            echo "Creating new environment..."
            
            # Get account ID for ARN construction
            ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
            
            if [ -z "$ACCOUNT_ID" ] || [ "$ACCOUNT_ID" = "None" ]; then
              echo "❌ Failed to get AWS Account ID"
              exit 1
            fi
            
            echo "Using Account ID: $ACCOUNT_ID"
            
            aws elasticbeanstalk create-environment \
              --application-name "${{ env.EB_APP_NAME }}" \
              --environment-name "${{ env.EB_ENV_NAME }}" \
              --platform-arn "${{ env.PLATFORM_ARN }}" \
              --version-label "${{ env.VERSION_LABEL }}" \
              --option-settings \
                Namespace=aws:autoscaling:launchconfiguration,OptionName=IamInstanceProfile,Value="${{ env.INSTANCE_PROFILE }}" \
                Namespace=aws:elasticbeanstalk:environment,OptionName=ServiceRole,Value="arn:aws:iam::${ACCOUNT_ID}:role/${{ env.SERVICE_ROLE }}" \
                Namespace=aws:elasticbeanstalk:application:environment,OptionName=API_URL,Value=http://smart-energy-grid-env.eba-qgkwbhh7.us-east-1.elasticbeanstalk.com \
                Namespace=aws:elasticbeanstalk:application:environment,OptionName=PORT,Value=3000 \
              --region "${{ env.AWS_REGION }}"

            echo "Waiting for environment to exist..."
            aws elasticbeanstalk wait environment-exists \
              --application-name "${{ env.EB_APP_NAME }}" \
              --environment-names "${{ env.EB_ENV_NAME }}" \
              --region "${{ env.AWS_REGION }}"
            
            echo "✅ Environment created"
          else
            echo "✅ Environment already exists: ${EXISTING_ENV}"
          fi

      - name: Deploy Frontend to Elastic Beanstalk
        run: |
          set -e
          echo "Deploying version ${{ env.VERSION_LABEL }} to environment..."
          aws elasticbeanstalk update-environment \
            --application-name "${{ env.EB_APP_NAME }}" \
            --environment-name "${{ env.EB_ENV_NAME }}" \
            --version-label "${{ env.VERSION_LABEL }}" \
            --region "${{ env.AWS_REGION }}"
          echo "✅ Deployment initiated"

      - name: Wait for Deployment
        run: |
          set -e
          echo "Waiting for environment to be ready..."
          max_attempts=30
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            status=$(aws elasticbeanstalk describe-environments \
              --application-name "${{ env.EB_APP_NAME }}" \
              --environment-names "${{ env.EB_ENV_NAME }}" \
              --region "${{ env.AWS_REGION }}" \
              --query 'Environments[0].Status' --output text 2>/dev/null || echo "Unknown")
            
            health=$(aws elasticbeanstalk describe-environments \
              --application-name "${{ env.EB_APP_NAME }}" \
              --environment-names "${{ env.EB_ENV_NAME }}" \
              --region "${{ env.AWS_REGION }}" \
              --query 'Environments[0].Health' --output text 2>/dev/null || echo "Unknown")
            
            echo "Status: $status, Health: $health"
            
            if [ "$status" = "Ready" ] && [ "$health" = "Green" ]; then
              echo "✅ Deployment successful!"
              exit 0
            fi
            
            if [ "$status" = "Ready" ] && [ "$health" = "Yellow" ]; then
              echo "⚠️ Deployment complete but health is Yellow"
              exit 0
            fi
            
            if [ "$health" = "Red" ]; then
              echo "❌ Deployment failed - Environment health is Red"
              echo ""
              echo "Recent events:"
              aws elasticbeanstalk describe-events \
                --application-name "${{ env.EB_APP_NAME }}" \
                --environment-name "${{ env.EB_ENV_NAME }}" \
                --max-items 10 \
                --region "${{ env.AWS_REGION }}"
              exit 1
            fi
            
            attempt=$((attempt + 1))
            echo "Waiting... ($attempt/$max_attempts)"
            sleep 20
          done
          
          echo "❌ Deployment timeout"
          exit 1

      - name: Output Environment URL
        if: success()
        run: |
          URL=$(aws elasticbeanstalk describe-environments \
            --application-name "${{ env.EB_APP_NAME }}" \
            --environment-names "${{ env.EB_ENV_NAME }}" \
            --query 'Environments[0].CNAME' --output text \
            --region "${{ env.AWS_REGION }}" 2>/dev/null || echo "")
          
          if [ -z "$URL" ] || [ "$URL" = "None" ]; then
            echo "⚠️ Could not retrieve environment URL"
          else
            echo "✅ Frontend URL: http://${URL}"
          fi
          | grep '^arn:' | head -n1 | tr -d '\n\r' | xargs)
          rm -f "$TEMP_FILE"
          
          echo "AL2023 Query result: '$PLATFORM_ARN'"

          # Check if AL2023 platform was found
          if [ -z "$PLATFORM_ARN" ] || [ "$PLATFORM_ARN" = "None" ] || [ "$PLATFORM_ARN" = "null" ] || [[ ! "$PLATFORM_ARN" =~ ^arn:aws:elasticbeanstalk: ]]; then
            echo "⚠️ AL2023 Go platform not found, trying any Go platform..."
            
            TEMP_FILE=$(mktemp)
            aws elasticbeanstalk list-platform-versions \
              --region "${{ env.AWS_REGION }}" \
              --query "reverse(sort_by(PlatformSummaryList[?contains(PlatformBranchName, 'Go')], &PlatformVersion))[0].PlatformArn" \
              --output text > "$TEMP_FILE" 2>&1
            
            # Read and clean the output
            PLATFORM_ARN=$(cat "$TEMP_FILE" | grep -v '^None

      - name: Check/Create IAM Instance Profile
        run: |
          set -e
          echo "Checking IAM Instance Profile..."
          
          if aws iam get-instance-profile --instance-profile-name "${{ env.INSTANCE_PROFILE }}" >/dev/null 2>&1; then
            echo "✅ Instance profile already exists"
          else
            echo "Creating IAM role and instance profile..."
            
            # Create the role
            aws iam create-role \
              --role-name "${{ env.INSTANCE_PROFILE }}" \
              --assume-role-policy-document '{
                "Version": "2012-10-17",
                "Statement": [{
                  "Effect": "Allow",
                  "Principal": {"Service": "ec2.amazonaws.com"},
                  "Action": "sts:AssumeRole"
                }]
              }' 2>/dev/null || echo "Role may already exist"
            
            # Attach managed policies
            aws iam attach-role-policy \
              --role-name "${{ env.INSTANCE_PROFILE }}" \
              --policy-arn arn:aws:iam::aws:policy/AWSElasticBeanstalkWebTier 2>/dev/null || true
            
            aws iam attach-role-policy \
              --role-name "${{ env.INSTANCE_PROFILE }}" \
              --policy-arn arn:aws:iam::aws:policy/AWSElasticBeanstalkWorkerTier 2>/dev/null || true
            
            aws iam attach-role-policy \
              --role-name "${{ env.INSTANCE_PROFILE }}" \
              --policy-arn arn:aws:iam::aws:policy/AWSElasticBeanstalkMulticontainerDocker 2>/dev/null || true
            
            # Create instance profile
            aws iam create-instance-profile \
              --instance-profile-name "${{ env.INSTANCE_PROFILE }}" 2>/dev/null || echo "Instance profile may already exist"
            
            # Add role to instance profile
            aws iam add-role-to-instance-profile \
              --instance-profile-name "${{ env.INSTANCE_PROFILE }}" \
              --role-name "${{ env.INSTANCE_PROFILE }}" 2>/dev/null || true
            
            echo "Waiting for IAM propagation..."
            sleep 10
            echo "✅ Instance profile created"
          fi

      - name: Check/Create Service Role
        run: |
          set -e
          echo "Checking Service Role..."
          
          if aws iam get-role --role-name "${{ env.SERVICE_ROLE }}" >/dev/null 2>&1; then
            echo "✅ Service role already exists"
          else
            echo "Creating service role..."
            
            aws iam create-role \
              --role-name "${{ env.SERVICE_ROLE }}" \
              --assume-role-policy-document '{
                "Version": "2012-10-17",
                "Statement": [{
                  "Effect": "Allow",
                  "Principal": {"Service": "elasticbeanstalk.amazonaws.com"},
                  "Action": "sts:AssumeRole",
                  "Condition": {
                    "StringEquals": {
                      "sts:ExternalId": "elasticbeanstalk"
                    }
                  }
                }]
              }' 2>/dev/null || echo "Role may already exist"
            
            aws iam attach-role-policy \
              --role-name "${{ env.SERVICE_ROLE }}" \
              --policy-arn arn:aws:iam::aws:policy/service-role/AWSElasticBeanstalkEnhancedHealth 2>/dev/null || true
            
            aws iam attach-role-policy \
              --role-name "${{ env.SERVICE_ROLE }}" \
              --policy-arn arn:aws:iam::aws:policy/AWSElasticBeanstalkManagedUpdatesCustomerRolePolicy 2>/dev/null || true
            
            echo "Waiting for IAM propagation..."
            sleep 10
            echo "✅ Service role created"
          fi

      - name: Check/Create EB Environment
        run: |
          set -e
          echo "Checking if environment exists..."
          
          EXISTING_ENV=$(aws elasticbeanstalk describe-environments \
            --application-name "${{ env.EB_APP_NAME }}" \
            --environment-names "${{ env.EB_ENV_NAME }}" \
            --query 'Environments[?Status!=`Terminated`].EnvironmentName' \
            --output text \
            --region "${{ env.AWS_REGION }}" 2>/dev/null || echo "")

          if [ -z "$EXISTING_ENV" ]; then
            echo "Creating new environment..."
            
            # Get account ID for ARN construction
            ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
            
            if [ -z "$ACCOUNT_ID" ] || [ "$ACCOUNT_ID" = "None" ]; then
              echo "❌ Failed to get AWS Account ID"
              exit 1
            fi
            
            echo "Using Account ID: $ACCOUNT_ID"
            
            aws elasticbeanstalk create-environment \
              --application-name "${{ env.EB_APP_NAME }}" \
              --environment-name "${{ env.EB_ENV_NAME }}" \
              --platform-arn "${{ env.PLATFORM_ARN }}" \
              --version-label "${{ env.VERSION_LABEL }}" \
              --option-settings \
                Namespace=aws:autoscaling:launchconfiguration,OptionName=IamInstanceProfile,Value="${{ env.INSTANCE_PROFILE }}" \
                Namespace=aws:elasticbeanstalk:environment,OptionName=ServiceRole,Value="arn:aws:iam::${ACCOUNT_ID}:role/${{ env.SERVICE_ROLE }}" \
                Namespace=aws:elasticbeanstalk:application:environment,OptionName=API_URL,Value=http://smart-energy-grid-env.eba-qgkwbhh7.us-east-1.elasticbeanstalk.com \
                Namespace=aws:elasticbeanstalk:application:environment,OptionName=PORT,Value=3000 \
              --region "${{ env.AWS_REGION }}"

            echo "Waiting for environment to exist..."
            aws elasticbeanstalk wait environment-exists \
              --application-name "${{ env.EB_APP_NAME }}" \
              --environment-names "${{ env.EB_ENV_NAME }}" \
              --region "${{ env.AWS_REGION }}"
            
            echo "✅ Environment created"
          else
            echo "✅ Environment already exists: ${EXISTING_ENV}"
          fi

      - name: Deploy Frontend to Elastic Beanstalk
        run: |
          set -e
          echo "Deploying version ${{ env.VERSION_LABEL }} to environment..."
          aws elasticbeanstalk update-environment \
            --application-name "${{ env.EB_APP_NAME }}" \
            --environment-name "${{ env.EB_ENV_NAME }}" \
            --version-label "${{ env.VERSION_LABEL }}" \
            --region "${{ env.AWS_REGION }}"
          echo "✅ Deployment initiated"

      - name: Wait for Deployment
        run: |
          set -e
          echo "Waiting for environment to be ready..."
          max_attempts=30
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            status=$(aws elasticbeanstalk describe-environments \
              --application-name "${{ env.EB_APP_NAME }}" \
              --environment-names "${{ env.EB_ENV_NAME }}" \
              --region "${{ env.AWS_REGION }}" \
              --query 'Environments[0].Status' --output text 2>/dev/null || echo "Unknown")
            
            health=$(aws elasticbeanstalk describe-environments \
              --application-name "${{ env.EB_APP_NAME }}" \
              --environment-names "${{ env.EB_ENV_NAME }}" \
              --region "${{ env.AWS_REGION }}" \
              --query 'Environments[0].Health' --output text 2>/dev/null || echo "Unknown")
            
            echo "Status: $status, Health: $health"
            
            if [ "$status" = "Ready" ] && [ "$health" = "Green" ]; then
              echo "✅ Deployment successful!"
              exit 0
            fi
            
            if [ "$status" = "Ready" ] && [ "$health" = "Yellow" ]; then
              echo "⚠️ Deployment complete but health is Yellow"
              exit 0
            fi
            
            if [ "$health" = "Red" ]; then
              echo "❌ Deployment failed - Environment health is Red"
              echo ""
              echo "Recent events:"
              aws elasticbeanstalk describe-events \
                --application-name "${{ env.EB_APP_NAME }}" \
                --environment-name "${{ env.EB_ENV_NAME }}" \
                --max-items 10 \
                --region "${{ env.AWS_REGION }}"
              exit 1
            fi
            
            attempt=$((attempt + 1))
            echo "Waiting... ($attempt/$max_attempts)"
            sleep 20
          done
          
          echo "❌ Deployment timeout"
          exit 1

      - name: Output Environment URL
        if: success()
        run: |
          URL=$(aws elasticbeanstalk describe-environments \
            --application-name "${{ env.EB_APP_NAME }}" \
            --environment-names "${{ env.EB_ENV_NAME }}" \
            --query 'Environments[0].CNAME' --output text \
            --region "${{ env.AWS_REGION }}" 2>/dev/null || echo "")
          
          if [ -z "$URL" ] || [ "$URL" = "None" ]; then
            echo "⚠️ Could not retrieve environment URL"
          else
            echo "✅ Frontend URL: http://${URL}"
          fi
          | grep '^arn:' | head -n1 | tr -d '\n\r' | xargs)
            rm -f "$TEMP_FILE"
            
            echo "Fallback Query result: '$PLATFORM_ARN'"
          fi
          
          # Final validation
          if [ -z "$PLATFORM_ARN" ] || [ "$PLATFORM_ARN" = "None" ] || [ "$PLATFORM_ARN" = "null" ]; then
            echo "❌ No Go platform found"
            exit 1
          fi
          
          # Ensure it's a valid ARN format - must start with arn:aws:elasticbeanstalk and not contain "None"
          if [[ ! "$PLATFORM_ARN" =~ ^arn:aws:elasticbeanstalk:[a-z0-9-]+:[0-9]+:platform/ ]]; then
            echo "❌ Invalid ARN format: '$PLATFORM_ARN'"
            exit 1
          fi
          
          # Check for "None" anywhere in the ARN (shouldn't happen but extra safety)
          if [[ "$PLATFORM_ARN" == *"None"* ]]; then
            echo "❌ ARN contains 'None': '$PLATFORM_ARN'"
            exit 1
          fi
          
          # Write to GITHUB_ENV only after all validation passes
          echo "✅ Using platform: $PLATFORM_ARN"
          {
            echo "PLATFORM_ARN=${PLATFORM_ARN}"
          } >> "$GITHUB_ENV"
          
          echo "✅ Platform ARN set successfully"

      - name: Check/Create IAM Instance Profile
        run: |
          set -e
          echo "Checking IAM Instance Profile..."
          
          if aws iam get-instance-profile --instance-profile-name "${{ env.INSTANCE_PROFILE }}" >/dev/null 2>&1; then
            echo "✅ Instance profile already exists"
          else
            echo "Creating IAM role and instance profile..."
            
            # Create the role
            aws iam create-role \
              --role-name "${{ env.INSTANCE_PROFILE }}" \
              --assume-role-policy-document '{
                "Version": "2012-10-17",
                "Statement": [{
                  "Effect": "Allow",
                  "Principal": {"Service": "ec2.amazonaws.com"},
                  "Action": "sts:AssumeRole"
                }]
              }' 2>/dev/null || echo "Role may already exist"
            
            # Attach managed policies
            aws iam attach-role-policy \
              --role-name "${{ env.INSTANCE_PROFILE }}" \
              --policy-arn arn:aws:iam::aws:policy/AWSElasticBeanstalkWebTier 2>/dev/null || true
            
            aws iam attach-role-policy \
              --role-name "${{ env.INSTANCE_PROFILE }}" \
              --policy-arn arn:aws:iam::aws:policy/AWSElasticBeanstalkWorkerTier 2>/dev/null || true
            
            aws iam attach-role-policy \
              --role-name "${{ env.INSTANCE_PROFILE }}" \
              --policy-arn arn:aws:iam::aws:policy/AWSElasticBeanstalkMulticontainerDocker 2>/dev/null || true
            
            # Create instance profile
            aws iam create-instance-profile \
              --instance-profile-name "${{ env.INSTANCE_PROFILE }}" 2>/dev/null || echo "Instance profile may already exist"
            
            # Add role to instance profile
            aws iam add-role-to-instance-profile \
              --instance-profile-name "${{ env.INSTANCE_PROFILE }}" \
              --role-name "${{ env.INSTANCE_PROFILE }}" 2>/dev/null || true
            
            echo "Waiting for IAM propagation..."
            sleep 10
            echo "✅ Instance profile created"
          fi

      - name: Check/Create Service Role
        run: |
          set -e
          echo "Checking Service Role..."
          
          if aws iam get-role --role-name "${{ env.SERVICE_ROLE }}" >/dev/null 2>&1; then
            echo "✅ Service role already exists"
          else
            echo "Creating service role..."
            
            aws iam create-role \
              --role-name "${{ env.SERVICE_ROLE }}" \
              --assume-role-policy-document '{
                "Version": "2012-10-17",
                "Statement": [{
                  "Effect": "Allow",
                  "Principal": {"Service": "elasticbeanstalk.amazonaws.com"},
                  "Action": "sts:AssumeRole",
                  "Condition": {
                    "StringEquals": {
                      "sts:ExternalId": "elasticbeanstalk"
                    }
                  }
                }]
              }' 2>/dev/null || echo "Role may already exist"
            
            aws iam attach-role-policy \
              --role-name "${{ env.SERVICE_ROLE }}" \
              --policy-arn arn:aws:iam::aws:policy/service-role/AWSElasticBeanstalkEnhancedHealth 2>/dev/null || true
            
            aws iam attach-role-policy \
              --role-name "${{ env.SERVICE_ROLE }}" \
              --policy-arn arn:aws:iam::aws:policy/AWSElasticBeanstalkManagedUpdatesCustomerRolePolicy 2>/dev/null || true
            
            echo "Waiting for IAM propagation..."
            sleep 10
            echo "✅ Service role created"
          fi

      - name: Check/Create EB Environment
        run: |
          set -e
          echo "Checking if environment exists..."
          
          EXISTING_ENV=$(aws elasticbeanstalk describe-environments \
            --application-name "${{ env.EB_APP_NAME }}" \
            --environment-names "${{ env.EB_ENV_NAME }}" \
            --query 'Environments[?Status!=`Terminated`].EnvironmentName' \
            --output text \
            --region "${{ env.AWS_REGION }}" 2>/dev/null || echo "")

          if [ -z "$EXISTING_ENV" ]; then
            echo "Creating new environment..."
            
            # Get account ID for ARN construction
            ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
            
            if [ -z "$ACCOUNT_ID" ] || [ "$ACCOUNT_ID" = "None" ]; then
              echo "❌ Failed to get AWS Account ID"
              exit 1
            fi
            
            echo "Using Account ID: $ACCOUNT_ID"
            
            aws elasticbeanstalk create-environment \
              --application-name "${{ env.EB_APP_NAME }}" \
              --environment-name "${{ env.EB_ENV_NAME }}" \
              --platform-arn "${{ env.PLATFORM_ARN }}" \
              --version-label "${{ env.VERSION_LABEL }}" \
              --option-settings \
                Namespace=aws:autoscaling:launchconfiguration,OptionName=IamInstanceProfile,Value="${{ env.INSTANCE_PROFILE }}" \
                Namespace=aws:elasticbeanstalk:environment,OptionName=ServiceRole,Value="arn:aws:iam::${ACCOUNT_ID}:role/${{ env.SERVICE_ROLE }}" \
                Namespace=aws:elasticbeanstalk:application:environment,OptionName=API_URL,Value=http://smart-energy-grid-env.eba-qgkwbhh7.us-east-1.elasticbeanstalk.com \
                Namespace=aws:elasticbeanstalk:application:environment,OptionName=PORT,Value=3000 \
              --region "${{ env.AWS_REGION }}"

            echo "Waiting for environment to exist..."
            aws elasticbeanstalk wait environment-exists \
              --application-name "${{ env.EB_APP_NAME }}" \
              --environment-names "${{ env.EB_ENV_NAME }}" \
              --region "${{ env.AWS_REGION }}"
            
            echo "✅ Environment created"
          else
            echo "✅ Environment already exists: ${EXISTING_ENV}"
          fi

      - name: Deploy Frontend to Elastic Beanstalk
        run: |
          set -e
          echo "Deploying version ${{ env.VERSION_LABEL }} to environment..."
          aws elasticbeanstalk update-environment \
            --application-name "${{ env.EB_APP_NAME }}" \
            --environment-name "${{ env.EB_ENV_NAME }}" \
            --version-label "${{ env.VERSION_LABEL }}" \
            --region "${{ env.AWS_REGION }}"
          echo "✅ Deployment initiated"

      - name: Wait for Deployment
        run: |
          set -e
          echo "Waiting for environment to be ready..."
          max_attempts=30
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            status=$(aws elasticbeanstalk describe-environments \
              --application-name "${{ env.EB_APP_NAME }}" \
              --environment-names "${{ env.EB_ENV_NAME }}" \
              --region "${{ env.AWS_REGION }}" \
              --query 'Environments[0].Status' --output text 2>/dev/null || echo "Unknown")
            
            health=$(aws elasticbeanstalk describe-environments \
              --application-name "${{ env.EB_APP_NAME }}" \
              --environment-names "${{ env.EB_ENV_NAME }}" \
              --region "${{ env.AWS_REGION }}" \
              --query 'Environments[0].Health' --output text 2>/dev/null || echo "Unknown")
            
            echo "Status: $status, Health: $health"
            
            if [ "$status" = "Ready" ] && [ "$health" = "Green" ]; then
              echo "✅ Deployment successful!"
              exit 0
            fi
            
            if [ "$status" = "Ready" ] && [ "$health" = "Yellow" ]; then
              echo "⚠️ Deployment complete but health is Yellow"
              exit 0
            fi
            
            if [ "$health" = "Red" ]; then
              echo "❌ Deployment failed - Environment health is Red"
              echo ""
              echo "Recent events:"
              aws elasticbeanstalk describe-events \
                --application-name "${{ env.EB_APP_NAME }}" \
                --environment-name "${{ env.EB_ENV_NAME }}" \
                --max-items 10 \
                --region "${{ env.AWS_REGION }}"
              exit 1
            fi
            
            attempt=$((attempt + 1))
            echo "Waiting... ($attempt/$max_attempts)"
            sleep 20
          done
          
          echo "❌ Deployment timeout"
          exit 1

      - name: Output Environment URL
        if: success()
        run: |
          URL=$(aws elasticbeanstalk describe-environments \
            --application-name "${{ env.EB_APP_NAME }}" \
            --environment-names "${{ env.EB_ENV_NAME }}" \
            --query 'Environments[0].CNAME' --output text \
            --region "${{ env.AWS_REGION }}" 2>/dev/null || echo "")
          
          if [ -z "$URL" ] || [ "$URL" = "None" ]; then
            echo "⚠️ Could not retrieve environment URL"
          else
            echo "✅ Frontend URL: http://${URL}"
          fi