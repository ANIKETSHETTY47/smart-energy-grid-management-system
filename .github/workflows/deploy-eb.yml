name: Deploy Backend to Elastic Beanstalk

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  EB_APPLICATION_NAME: smart-energy-grid
  EB_ENVIRONMENT_NAME: smart-energy-grid-env

jobs:
  deploy:
    name: Deploy Backend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Go (sanity build only)
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Sanity Build (does not ship this binary)
        run: |
          go mod download
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -o application ./cmd/api
          echo "Sanity build ok"

      - name: Install EB CLI
        run: |
          python3 -m pip install --upgrade --user awsebcli
          echo "$(python3 -m site --user-base)/bin" >> "$GITHUB_PATH"

      - name: Initialize EB Config
        run: |
          mkdir -p .elasticbeanstalk
          cat > .elasticbeanstalk/config.yml << 'EOF'
          branch-defaults:
            main:
              environment: ${{ env.EB_ENVIRONMENT_NAME }}
          global:
            application_name: ${{ env.EB_APPLICATION_NAME }}
            default_region: ${{ env.AWS_REGION }}
            platform: Go 1 running on 64bit Amazon Linux 2023
            sc: git
            workspace_type: Application
          EOF

      - name: Ensure Application Exists
        run: |
          if ! aws elasticbeanstalk describe-applications \
              --application-names "${{ env.EB_APPLICATION_NAME }}" \
              --query 'Applications[0].ApplicationName' \
              --output text 2>/dev/null | grep -q "${{ env.EB_APPLICATION_NAME }}"; then
            aws elasticbeanstalk create-application \
              --application-name "${{ env.EB_APPLICATION_NAME }}"
          fi

      - name: EB Init
        run: |
          eb init "${{ env.EB_APPLICATION_NAME }}" \
            --platform "Go 1 running on 64bit Amazon Linux 2023" \
            --region "${{ env.AWS_REGION }}"

      - name: Create Environment if Missing
        run: |
          if ! aws elasticbeanstalk describe-environments \
              --application-name "${{ env.EB_APPLICATION_NAME }}" \
              --environment-names "${{ env.EB_ENVIRONMENT_NAME }}" \
              --query 'Environments[?Status!=`Terminated`]' \
              --output text | grep -q .; then
            eb create "${{ env.EB_ENVIRONMENT_NAME }}" \
              --single --instance_type t3.micro \
              --service-role aws-elasticbeanstalk-service-role \
              --instance_profile aws-elasticbeanstalk-ec2-role \
              --timeout 20
          fi
          eb use "${{ env.EB_ENVIRONMENT_NAME }}"

      - name: Deploy Application
        run: |
          # EB will use Buildfile (builds ./application) and Procfile (web: ./application)
          eb deploy "${{ env.EB_ENVIRONMENT_NAME }}" --timeout 20

      - name: Show Environment CNAME
        run: |
          eb status "${{ env.EB_ENVIRONMENT_NAME }}" | awk '/CNAME/ {print "Backend URL: http://"$2}'
