name: Deploy Backend to Elastic Beanstalk

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  EB_APPLICATION_NAME: smart-energy-grid
  EB_ENVIRONMENT_NAME: smart-energy-grid-env

jobs:
  deploy:
    name: Deploy Backend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install EB CLI
        run: |
          pip install awsebcli --upgrade --user
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Initialize Elastic Beanstalk
        run: |
          eb --version
          
          mkdir -p .elasticbeanstalk
          
          cat > .elasticbeanstalk/config.yml << 'EOF'
branch-defaults:
  main:
    environment: smart-energy-grid-env
global:
  application_name: smart-energy-grid
  default_region: us-east-1
  platform: Go 1 running on 64bit Amazon Linux 2023
  sc: git
  workspace_type: Application
EOF
          
          echo "EB Configuration created:"
          cat .elasticbeanstalk/config.yml
          
          cat > .ebignore << 'EOF'
.git
.github
*.md
.env*
node_modules
.vscode
.idea
*.log
.elasticbeanstalk/*
!.elasticbeanstalk/*.cfg.yml
!.elasticbeanstalk/*.global.yml
EOF
          
          echo "Created .ebignore"

      - name: Create or Use Existing Environment
        run: |
          set -e
          
          echo "Checking if environment exists..."
          if aws elasticbeanstalk describe-environments \
            --application-name smart-energy-grid \
            --environment-names smart-energy-grid-env \
            --region us-east-1 \
            --query 'Environments[?Status!=`Terminated`]' \
            --output text | grep -q .; then
            echo "✅ Environment exists, will deploy to it"
          else
            echo "Creating new environment..."
            echo "This will take approximately 5-10 minutes..."
            
            eb create smart-energy-grid-env \
              --instance-type t3.micro \
              --single \
              --timeout 20 \
              --service-role aws-elasticbeanstalk-service-role \
              --instance_profile aws-elasticbeanstalk-ec2-role \
              --yes || {
                echo "❌ Failed to create environment"
                eb events smart-energy-grid-env --follow || true
                exit 1
              }
            
            echo "✅ Environment created successfully"
          fi

      - name: Deploy Application
        run: |
          eb deploy smart-energy-grid-env

      - name: Get Environment Info
        run: |
          eb status smart-energy-grid-env
          echo ""
          echo "================================"
          echo "✅ Backend URL:"
          eb status smart-energy-grid-env | grep "CNAME" | awk '{print "http://"$2}'
          echo "================================"
          echo ""
          echo "⚠️  IMPORTANT: Copy the backend URL above and update it in deploy-frontend.yml"